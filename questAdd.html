<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width">
    <title>クエストの設定</title>
    <style media="screen">
      body {
        margin: 0;
      }
      .center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .textCenter {
        text-align: center;
      }
      .flex {
        display: flex;
      }
      .displayNone {
        display: none;
      }
      .widthHundredPercent {
        width: 100%;
      }

      .form {
        padding: 8px;
      }

      .formTable.parentTable {
        width: 90%;
      }
      .formTable tr td:nth-child(1) {
        text-align: right;
      }

      .childTable {
        border: solid 1px #aaa;
      }

      #submit {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="form center">
      <table class="formTable parentTable">
        <tbody>
          <tr class="all">
            <td>種類:</td>
            <td>
              <select class="questType widthHundredPercent">
                <!-- <option value="">選択してください</option> -->
                <option value="dailyQuests">デイリー</option>
                <option value="normalQuests">ノーマル</option>
                <option value="countQuests">カウント</option>
              </select>
            </td>
          </tr>
          <tr class="all">
            <td>名前:</td>
            <td>
              <input type="text" class="questName widthHundredPercent">
            </td>
          </tr>
          <tr class="all">
            <td>説明:</td>
            <td>
              <input type="text" class="questDescription widthHundredPercent">
            </td>
          </tr>
          <tr class="all">
            <td>難易度:</td>
            <td>
              <select class="questDifficulty widthHundredPercent">
                <!-- <option value="">選択してください</option> -->
                <option value="1">★</option>
                <option value="2">★★</option>
                <option value="3">★★★</option>
                <option value="4">★★★★</option>
              </select>
            </td>
          </tr>
          <tr class="dailyQuests normalQuests">
            <td>子クエスト:</td>
            <td>
              <label>
                <input type="radio" class="haveChild" name="addHaveChild" checked>
                <span>なし</span>
              </label>
              &nbsp;
              <label>
                <input type="radio" class="haveChild" name="addHaveChild">
                <span>あり</span>
              </label>
            </td>
          </tr>
          <tr class="dailyQuests normalQuests noneChild">
            <td>目標回数:</td>
            <td>
              <select class="questMaxCount widthHundredPercent">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
                <option>13</option>
                <option>14</option>
                <option>15</option>
                <option>16</option>
                <option>17</option>
                <option>18</option>
                <option>19</option>
                <option>20</option>
              </select>
            </td>
          </tr>
          <tr class="dailyQuests normalQuests haveChild childTable displayNone">
            <td></td>
            <td>
              <table class="formTable childTable">
                <tr>
                  <td>名前:</td>
                  <td>
                    <input type="text" class="questName">
                  </td>
                </tr>
                <tr>
                  <td>説明:</td>
                  <td>
                    <input type="text" class="questDescription">
                  </td>
                </tr>
                <tr class="daily normal">
                  <td>目標回数:</td>
                  <td>
                    <select class="questMaxCount widthHundredPercent">
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                      <option>4</option>
                      <option>5</option>
                      <option>6</option>
                      <option>7</option>
                      <option>8</option>
                      <option>9</option>
                      <option>10</option>
                      <option>11</option>
                      <option>12</option>
                      <option>13</option>
                      <option>14</option>
                      <option>15</option>
                      <option>16</option>
                      <option>17</option>
                      <option>18</option>
                      <option>19</option>
                      <option>20</option>
                    </select>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr class="dailyQuests normalQuests haveChild displayNone">
            <td></td>
            <td style="text-align: right;">
              <input type="button" class="childQuestAdd" value="+">
              <input type="button" class="childQuestRemove" value="-">
            </td>
          </tr>
        </tbody>
      </table>
      <input type="button" id="submit" value="完了">
    </div>

    <script src="https://d.line-scdn.net/liff/1.0/sdk.js" charset="utf-8"></script>
    <script type="text/javascript">
      var lineData;

      var selectType = document.querySelector('.questType');
      var radioHaveChild = document.querySelector('input.haveChild');

      var childQuestAdd = document.getElementsByClassName('childQuestAdd')[0];
      var childQuestRemove = document.getElementsByClassName('childQuestRemove')[0];

      var submit = document.getElementById('submit');

      selectType.addEventListener('change', function() {
        changeForm();
      }, false);
      radioHaveChild.addEventListener('change', function() {
        changeForm();
      }, false);
      document.querySelectorAll('input.haveChild')[1].addEventListener('change', function() {
        changeForm();
      }, false);

      childQuestAdd.addEventListener('click', function() {
        if (document.querySelectorAll('tr.childTable').length >= 20) return;

        var lastChild = document.querySelector('tr.childTable:nth-last-of-type(2)');

        var tr = document.createElement('tr');
        tr.setAttribute('class', 'daily normal haveChild childTable');
        tr.innerHTML +=
          '<td></td>' +
          '<td>' +
          '<table class="formTable childTable">' +
          '<tr>' +
          '<td>名前:</td>' +
          '<td>' +
          '<input type="text" class="questName">' +
          '</td>' +
          '</tr>' +
          '<tr>' +
          '<td>説明:</td>' +
          '<td>' +
          '<input type="text" class="questDescription">' +
          '</td>' +
          '</tr>' +
          '<tr class="daily normal">' +
          '<td>目標回数:</td>' +
          '<td>' +
          '<select class="questMaxCount widthHundredPercent">' +
          '<option>1</option>' +
          '<option>2</option>' +
          '<option>3</option>' +
          '<option>4</option>' +
          '<option>5</option>' +
          '<option>6</option>' +
          '<option>7</option>' +
          '<option>8</option>' +
          '<option>9</option>' +
          '<option>10</option>' +
          '<option>11</option>' +
          '<option>12</option>' +
          '<option>13</option>' +
          '<option>14</option>' +
          '<option>15</option>' +
          '<option>16</option>' +
          '<option>17</option>' +
          '<option>18</option>' +
          '<option>19</option>' +
          '<option>20</option>' +
          '</select>' +
          '</td>' +
          '</tr>' +
          '</table>' +
          '</td>';

        lastChild.parentNode.insertBefore(tr, lastChild.nextSibling);
      }, false);
      childQuestRemove.addEventListener('click', function() {
        if (document.querySelectorAll('tr.childTable').length <= 1) return;


        var lastChild = document.querySelector('tr.childTable:nth-last-of-type(2)');
        lastChild.parentNode.removeChild(lastChild);
      }, false);

      submit.addEventListener('click', function() {
        sendData();
      }, false);

      function clickTab (i) {
        for (var l = 0; l < tabs.length; l++) {
          tabs[l].classList.remove('selected');
        }
        tabs[i].classList.add('selected');
        tab = i;
      }

      function changeForm() {
        var addType = selectType.value;
        var haveChild = (function() {
          if (radioHaveChild.checked) {
            return 'haveChild';
          }
          return 'noneChild';
        })();

        var parentTRs = document.querySelectorAll('.parentTable>tbody>tr');
        for (var i = 0; i < parentTRs.length; i++) {
          var fitType = parentTRs[i].classList.contains(addType) || parentTRs[i].classList.contains('all');
          var fitHaveChild = parentTRs[i].classList.contains(haveChild);

          parentTRs[i].classList.remove('displayNone');
          if (!fitType || fitHaveChild) {
            parentTRs[i].classList.add('displayNone');
          }
        }
      }

      function sendData() {
        // var formData = createFormData();
        // var message = createMessage(formData);
        // console.log(message);
        liff.init(
          data => {
            alert('ok');
            var formData = createFormData();
            var message = createMessage(formData);
            liff.sendMessages([
              {
                type: 'text',
                text: message
              }
            ])
            .then(() => {
              liff.closeWindow();
            })
            .catch((err) => {
              alert('error liff.sendMessages');
            });
          },
          err => {
            alert('error liff.init');
          }
        );
      }

      function createFormData() {
        var data = {};
        data.type = selectType.value;
        data.quests = {};
        data.quests.name = (() => {
          var a = document.querySelector('.parentTable>tbody>tr>td>.questName').value;
          if (a == '') return ' ';
          return a;
        })();
        data.quests.description = (() => {
          var a = document.querySelector('.parentTable>tbody>tr>td>.questDescription').value;
          if (a == '') return ' ';
          return a;
        })();
        data.quests.difficulty = +document.querySelector('.parentTable>tbody>tr>td>.questDifficulty').value;
        data.quests.count = 0;
        data.quests.maxCount = 0;
        data.quests.childQuests = [];
        data.haveChild = !radioHaveChild.checked;
        if (data.haveChild) {
          var childQuests = document.querySelectorAll('tr.childTable');
          for (var i = 0; i < childQuests.length; i++) {
            var addChildQuest = {};
            addChildQuest.name = (() => {
              var a = childQuests[i].getElementsByClassName('questName')[0].value;
              if (a == '') return ' ';
              return a;
            })();
            addChildQuest.description = (() => {
              var a = childQuests[i].getElementsByClassName('questDescription')[0].value;
              if (a == '') return ' ';
              return a;
            })();
            addChildQuest.count = 0;
            addChildQuest.maxCount = +childQuests[i].getElementsByClassName('questMaxCount')[0].value;
            data.quests.childQuests.push(addChildQuest);
            data.quests.maxCount += +addChildQuest.maxCount;
          }
        }
        else {
          data.quests.maxCount = +document.querySelector('.parentTable>tbody>tr>td>.questMaxCount').value;
        }
        return data;
      }

      function createMessage(data) {
        var message = (() => {
          if (data.type == 'dailyQuests') return 'デイリークエストの追加\n';
          if (data.type == 'normalQuests') return 'ノーマルクエストの追加\n';
          if (data.type == 'countQuests') return 'カウントクエストの追加\n';
        })();
        message += '　　名前 : ' + data.quests.name + '\n';
        message += '　　説明 : ' + data.quests.description + '\n';
        message += '　難易度 : ' + data.quests.difficulty + '\n';
        message += (() => {
          if (data.type == 'countQuests') {
            return '';
          }
          return '目標回数 : ' + data.quests.maxCount + '\n';
        })();
        for (var i = 0; i < data.quests.childQuests.length; i++) {
          message += '子クエスト' + (i + 1) + '\n';
          message += '　　名前 : ' + data.quests.childQuests[i].name + '\n';
          message += '　　説明 : ' + data.quests.childQuests[i].description + '\n';
          message += '目標回数 : ' + data.quests.childQuests[i].maxCount + '\n';
        }
        message = message.replace(/(\r\n|\r|\n)+$/, '');
        return message;
      }
    </script>
  </body>
</html>
